!function(c){window.llms=window.llms||{},window.llms.metabox_product=function(){this.$plans=null,this.$save=null,this.$plan_dialog=null,this.temp_id=Math.floor(7777*Math.random()+777),this.validation_class="llms-invalid",this.init=function(e){var a,l,n=this,t=(n.$plans=c("#llms-access-plans"),n.$save=c("#llms-save-access-plans"),n.bind_visibility(),c("#lifterlms-product #llms-product-options-access-plans"));t.length&&(n.requiresAttention(),e?n.bind():(LLMS.Spinner.start(t),a=0,l=setInterval(function(){if(300<=a)t.html(LLMS.l10n.translate("There was an error loading the necessary resources. Please try again."));else{if("undefined"==typeof tinyMCE)return void a++;n.bind()}clearInterval(l),LLMS.Spinner.stop(t)},100)))},this.bind=function(){var n=this,e=(setTimeout(function(){n.has_plan_limit_been_reached()&&n.toggle_create_button("disable")},500),0===n.get_current_plan_count()&&n.toggle_save_button("disable"),n.$save.on("click",function(e){e.preventDefault(),n.save_plans()}),n.$plans.on("change","[data-controller-id]",function(){n.controller_change(c(this))}),n.$plans.on("change",'select[name$="[availability]"]',function(){var e=c(this).closest(".llms-access-plan"),a=e.find('input[name$="[checkout_redirect_forced]"]'),l=e.find(".llms-checkout-redirect-settings");"members"===c(this).val()?(a.prop("checked")?l.show():l.hide(),a.on("change",function(){l.toggle()})):(a.off("change"),l.show())}),c("#llms-access-plans .llms-access-plan-datepicker").datepicker({dateFormat:"mm/dd/yy"}),c("#llms-access-plans [data-controller-id]").trigger("change"),document.getElementById("llms-access-plan-dialog"));e&&(n.$plan_dialog=new A11yDialog(e)),c("span.llms-nav-link").filter(function(){return c(this).text().trim()===LLMS.l10n.translate("Restrictions")}).length&&c("#_llms_time_period").length||c('.llms-access-plan-templates button[data-template="presell"]').hide(),c("#llms-new-access-plan").on("click",function(){n.init_plan(),n.$plan_dialog&&n.$plan_dialog.show(),n.toggle_create_button("disable"),n.toggle_save_button("enable"),setTimeout(function(){n.has_plan_limit_been_reached()||n.toggle_create_button("enable")},500)}),c("#llms-access-plan-dialog .llms-access-plan-templates button.template").on("click",function(e){e.preventDefault(),n.$plan_dialog&&n.$plan_dialog.hide();var a=n.$plans.find(".llms-access-plan").last();switch(c(this).attr("data-template")){case"free":a.find('input[name^="_llms_plans["][name$="[title]"]').val(LLMS.l10n.translate("Free")).change(),a.find('select[name^="_llms_plans["][name$="[is_free]"]').val("yes").change();break;case"monthly":a.find('input[name^="_llms_plans["][name$="[title]"]').val(LLMS.l10n.translate("Monthly")).change(),a.find('input[name^="_llms_plans["][name$="[price]"]').val("100").change(),a.find('select[name^="_llms_plans["][name$="[frequency]"]').val("1").change(),a.find('select[name^="_llms_plans["][name$="[period]"]').val("month").change();break;case"annual":a.find('input[name^="_llms_plans["][name$="[title]"]').val(LLMS.l10n.translate("Annual")).change(),a.find('input[name^="_llms_plans["][name$="[price]"]').val("1000").change(),a.find('select[name^="_llms_plans["][name$="[frequency]"]').val("1").change(),a.find('select[name^="_llms_plans["][name$="[period]"]').val("year").change();break;case"one-time":a.find('input[name^="_llms_plans["][name$="[title]"]').val(LLMS.l10n.translate("One Time")).change(),a.find('input[name^="_llms_plans["][name$="[price]"]').val("1000").change(),a.find('select[name^="_llms_plans["][name$="[frequency]"]').val("0").change(),a.find('select[name^="_llms_plans["][name$="[access_expiration]"]').val("limited-period").change(),a.find('input[name^="_llms_plans["][name$="[access_length]"]').val("1").change(),a.find('select[name^="_llms_plans["][name$="[access_period]"]').val("year").change();break;case"lifetime":a.find('input[name^="_llms_plans["][name$="[title]"]').val(LLMS.l10n.translate("Lifetime")).change(),a.find('input[name^="_llms_plans["][name$="[price]"]').val("1000").change(),a.find('select[name^="_llms_plans["][name$="[frequency]"]').val("0").change(),a.find('select[name^="_llms_plans["][name$="[access_expiration]"]').val("lifetime").change();break;case"paid-trial":a.find('input[name^="_llms_plans["][name$="[title]"]').val(LLMS.l10n.translate("Paid Trial")).change(),a.find('input[name^="_llms_plans["][name$="[price]"]').val("100").change(),a.find('select[name^="_llms_plans["][name$="[frequency]"]').val("1").change(),a.find('select[name^="_llms_plans["][name$="[period]"]').val("month").change(),a.find('select[name^="_llms_plans["][name$="[trial_offer]"]').val("yes").change(),a.find('input[name^="_llms_plans["][name$="[trial_price]"]').val("1").change(),a.find('input[name^="_llms_plans["][name$="[trial_length]"]').val("1").change(),a.find('select[name^="_llms_plans["][name$="[trial_period]"]').val("week").change();break;case"free-trial":a.find('input[name^="_llms_plans["][name$="[title]"]').val(LLMS.l10n.translate("Free Trial")).change(),a.find('input[name^="_llms_plans["][name$="[price]"]').val("100").change(),a.find('select[name^="_llms_plans["][name$="[frequency]"]').val("1").change(),a.find('select[name^="_llms_plans["][name$="[period]"]').val("month").change(),a.find('select[name^="_llms_plans["][name$="[trial_offer]"]').val("yes").change(),a.find('input[name^="_llms_plans["][name$="[trial_price]"]').val("0").change(),a.find('input[name^="_llms_plans["][name$="[trial_length]"]').val("1").change(),a.find('select[name^="_llms_plans["][name$="[trial_period]"]').val("week").change();break;case"hidden-access":a.find('input[name^="_llms_plans["][name$="[title]"]').val(LLMS.l10n.translate("Hidden Access")).change(),a.find('select[name^="_llms_plans["][name$="[visibility]"]').val("hidden").change(),a.find('select[name^="_llms_plans["][name$="[is_free]"]').val("yes").change();break;case"sale":a.find('input[name^="_llms_plans["][name$="[title]"]').val(LLMS.l10n.translate("Sale")).change(),a.find('input[name^="_llms_plans["][name$="[price]"]').val("1000").change(),a.find('select[name^="_llms_plans["][name$="[on_sale]"]').val("yes").change(),a.find('input[name^="_llms_plans["][name$="[sale_price]"]').val("500").change();break;case"presell":a.find('input[name^="_llms_plans["][name$="[title]"]').val(LLMS.l10n.translate("Pre-sale")).change(),a.find('input[name^="_llms_plans["][name$="[price]"]').val("1000").change();var l=c("span.llms-nav-link").filter(function(){return"Restrictions"===c(this).text().trim()});l.length&&(l.click(),c("#_llms_time_period").is(":checked")||c("#_llms_time_period").click(),(l=new Date).setMonth(l.getMonth()+1),l=(l.getMonth()+1).toString().padStart(2,"0")+`/${l.getDate().toString().padStart(2,"0")}/`+l.getFullYear().toString(),c("#_llms_start_date").val(l).change());break;case"advanced":break;default:n.$plans.trigger("llms-access-plan-template-"+c(this).attr("data-template"))}}),n.$plans.sortable({handle:".llms-drag-handle",items:".llms-access-plan",start:function(e,a){n.$plans.addClass("dragging")},stop:function(e,a){n.$plans.removeClass("dragging"),n.update_plan_orders()}}),n.$plans.on("keyup","input.llms-plan-title",function(){var e=c(this),a=e.closest(".llms-access-plan").find("span.llms-plan-title"),e=e.val(),e=e||a.attr("data-default");a.text(e)}),n.$plans.on("focusin","input",function(e,a){c(this).addClass("llms-has-been-focused")}),n.$plans.on("keyup focusout llms-validate-plan-field","input",function(e,a){var l=c(this);l[0].checkValidity()?l.removeClass(n.validation_class):(l.addClass(n.validation_class),"keyup"===e.type&&l[0].reportValidity()),a&&!a.cascade||l.closest(".llms-access-plan").trigger("llms-validate-plan",{original_event:e.type})}),n.$plans.on("llms-validate-plan",".llms-access-plan",function(e,a){a=a||{};var l=c(this),a=a.original_event?"input.llms-has-been-focused":"input";l.find(a).each(function(){c(this).trigger("llms-validate-plan-field",{cascade:!1})}),l.find("."+n.validation_class).length?l.addClass(n.validation_class):l.removeClass(n.validation_class)}),n.$plans.on("llms-collapsible-toggled",".llms-access-plan",function(){var e=c(this);e.hasClass("opened")&&setTimeout(function(){e.find("input.llms-invalid").each(function(){c(this)[0].reportValidity()})},500)}),n.$plans.on("click",".llms-plan-delete",function(e){e.stopPropagation(),n.delete_plan(c(this))}),window.llms.metaboxes.post_select(c("#llms-access-plans .llms-availability-restrictions")),window.llms.metaboxes.post_select(c("#llms-access-plans .llms-checkout-redirect-page")),c("#_llms_plans_content_llms-new-access-plan-model").attr("disabled","disabled"),tinyMCE.EditorManager.execCommand("mceRemoveEditor",!0,"_llms_plans_content_llms-new-access-plan-model")},this.bind_visibility=function(){var a=c("#llms-catalog-visibility-select"),l=c("a.llms-edit-catalog-visibility"),e=c("a.llms-save-catalog-visibility"),n=c("a.llms-cancel-catalog-visibility");l.on("click",function(e){e.preventDefault(),a.slideDown("fast"),l.hide()}),e.on("click",function(e){e.preventDefault(),a.slideUp("fast"),l.show(),c("#llms-catalog-visibility-display").text(c('input[name="_llms_visibility"]:checked').attr("data-label"))}),n.on("click",function(e){e.preventDefault(),a.slideUp("fast"),l.show()})},this.requiresAttention=function(){this.$plans.find(".llms-access-plan").each(function(){c(this).toggleClass("llms-needs-attention",0<c(this).find(".notice").not(".llms-payment-gateway-warning").length)})},this.delete_plan=function(e){var a=this,l=e.closest(".llms-access-plan"),e=l.attr("data-id"),n=LLMS.l10n.translate("After deleting this access plan, any students subscribed to this plan will still have access and will continue to make recurring payments according to the access plan's settings. If you wish to terminate their plans you must do so manually. This action cannot be reversed.");e?window.confirm(n)&&(LLMS.Spinner.start(l),window.LLMS.Ajax.call({data:{action:"delete_access_plan",plan_id:e},success:function(e){setTimeout(function(){LLMS.Spinner.stop(l)},550),e.success?(a.remove_plan_el(l),a.trigger_update_hook(),setTimeout(function(){a.update_plan_orders()},500)):e.message&&alert(e.message)}})):a.remove_plan_el(l)},this.controller_change=function(e){var a=e.attr("data-controller-id"),i=e.val(),a=e.closest(".llms-access-plan").find('[data-controller="'+a+'"]');"checkbox"===e.attr("type")&&(i=e.is(":checked")?i:"no"),a.each(function(){var e,a,l=c(this),n="SELECT"===l[0].nodeName||"INPUT"===l[0].nodeName||"TEXTAREA"===l[0].nodeName?l:l.find("input, select, textarea"),t=l.attr("data-value-is"),s=l.attr("data-value-is-not");switch(void 0!==t&&!1!==t?a="==":void 0!==s&&!1!==s&&(a="!="),a){case"==":e=i==t?"show":"hide";break;case"!=":e=i!=s?"show":"hide"}"show"===e?(l.show(),n.removeAttr("disabled").trigger("change")):"hide"===e&&(l.hide(),n.attr("disabled","disabled"))})},this.get_current_plan_count=function(){return this.$plans.find(".llms-access-plan").length},this.get_plans_array=function(){tinyMCE.triggerSave();for(var e,a,l,n=this.$plans.closest("form").serializeArray(),t=[],s=0;s<n.length;s++)-1!==n[s].name.indexOf("_llms_plans")&&(e=+(l=n[s].name.replace("_llms_plans[","").split("]["))[0]-1,a=l[1].replace("]",""),l=3===l.length?"array":"single",t[e]||(t[e]={}),"array"==l?(t[e][a]||(t[e][a]=[]),t[e][a].push(n[s].value)):t[e][a]=n[s].value);return t},this.has_plan_limit_been_reached=function(){var e=window.llms.product.access_plan_limit;return this.get_current_plan_count()>=e},this.init_plan=function(){var e;this.has_plan_limit_been_reached()||(e=c("#llms-new-access-plan-model").clone(),$existing_plans=c("#llms-access-plans .llms-access-plan"),$editor=e.find("#_llms_plans_content_llms-new-access-plan-model"),e.removeAttr("id"),$editor.removeAttr("id").attr("id","_llms_plans_content_"+this.temp_id),this.temp_id++,e.find("select, input, textarea").each(function(){c(this).removeAttr("disabled")}),e.appendTo("#llms-access-plans"),this.update_plan_orders(),e.find(".llms-access-plan-datepicker").datepicker({dateFormat:"mm/dd/yy"}),e.find(".llms-collapsible-header").trigger("click"),this.has_plan_limit_been_reached()&&this.toggle_create_button("disable"),window.llms.metaboxes.post_select(e.find(".llms-availability-restrictions")),window.llms.metaboxes.post_select(e.find(".llms-checkout-redirect-page")),e.find("[data-controller-id]").trigger("change"),c(document).trigger("llms-plan-init",e))},this.save_plans=function(){var a=this;a.$plans.find(".llms-access-plan").not("#llms-new-access-plan-model").each(function(){c(this).trigger("llms-validate-plan")}),a.$plans.find("."+a.validation_class).length?(a.$plans.find(".llms-access-plan."+a.validation_class).not(".opened").first().find(".llms-collapsible-header").trigger("click"),c(document).trigger("llms-access-plan-validation-errors")):(LLMS.Spinner.start(a.$plans),a.$save.attr("disabled","disabled"),window.LLMS.Ajax.call({data:{action:"llms_update_access_plans",plans:a.get_plans_array()},complete:function(){LLMS.Spinner.stop(a.$plans),a.$save.removeAttr("disabled")},error:function(e,a,l){console.error("llms access plan save error encounterd:",e),alert(LLMS.l10n.translate("An error was encountered during the save attempt. Please try again.")+" ["+a+": "+l+"]")},success:function(e){!e.success&&e.code&&"error"===e.code?alert(e.message):e.data&&e.data.html&&(c("#llms-product-options-access-plans").replaceWith(e.data.html),a.init(!0),window.llms.metaboxes.init(),a.update_plan_orders(),a.trigger_update_hook())}}))},this.toggle_button=function(e,a){"disable"===a?e.attr("disabled","disabled"):e.removeAttr("disabled")},this.toggle_create_button=function(e){this.toggle_button(c("#llms-new-access-plan"),e)},this.toggle_save_button=function(e){this.toggle_button(this.$save,e)},this.remove_plan_el=function(e){var a=this;e.fadeOut(400),setTimeout(function(){e.remove(),a.has_plan_limit_been_reached()||a.toggle_create_button("enable"),0===a.get_current_plan_count()&&a.toggle_save_button("disable")},450)},this.trigger_update_hook=function(){c(document).trigger("llms-access-plans-updated")},this.update_plan_orders=function(){c("#llms-access-plans .llms-access-plan").each(function(){var e=c(this),a=e.find(".plan-order"),l=e.find('textarea[id^="_llms_plans_content_"]').attr("id"),n=+a.val(),t=e.index(),s=tinyMCE.EditorManager.get(l),s=(s||tinyMCE.EditorManager).settings;s.selector="#"+l,tinyMCE.EditorManager.execCommand("mceRemoveEditor",!0,l),e.find("label, select, input, textarea").each(function(){var e=c(this).attr("for"),e=(e&&c(this).attr("for",e.replace(n,t)),c(this).attr("id")),e=(e&&c(this).attr("id",e.replace(n,t)),c(this).attr("name"));e&&c(this).attr("name",e.replace(n,t))}),tinyMCE.EditorManager.init(s),a.val(t)})},this.init()};new window.llms.metabox_product}(jQuery);
//# sourceMappingURL=../maps/js/llms-metabox-product.min.js.map
